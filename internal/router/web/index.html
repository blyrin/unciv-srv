<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unciv æœåŠ¡å™¨ç®¡ç†</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    [v-cloak] { display: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased min-h-screen">

<div id="app" v-cloak class="flex flex-col min-h-screen">

  <div class="fixed top-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
    <div v-for="toast in toasts" :key="toast.id"
         :class="['pointer-events-auto px-4 py-3 rounded-lg border border-white/20 text-white text-sm font-medium flex items-center gap-2 min-w-[300px]',
                 toast.type === 'error' ? 'bg-red-500' : 'bg-emerald-500']">
      <span v-if="toast.type === 'success'">âœ“</span>
      <span v-else>âœ•</span>
      {{ toast.message }}
    </div>
  </div>

  <div v-if="modal.show"
       class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm flex items-center justify-center p-2 sm:p-4"
       @click.self="closeModal">
    <div
      class="bg-white rounded-xl border border-gray-300 w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden transform">
      <div class="p-3 border-b flex justify-between items-center bg-gray-50">
        <h3 class="font-bold text-base text-gray-700 truncate pr-2">{{ modal.title }}</h3>
        <button @click="closeModal" class="text-gray-400 hover:text-gray-600 flex-shrink-0">âœ•</button>
      </div>
      <div class="overflow-y-auto p-4 sm:p-0">
        <div v-if="modal.type === 'html'" v-html="modal.content"></div>

        <div v-if="modal.type === 'edit'" class="space-y-4 sm:p-4">
          <label class="flex items-center space-x-2">
            <input type="checkbox" v-model="modal.data.whitelist"
                   class="rounded text-emerald-600 focus:ring-emerald-500 w-5 h-5">
            <span class="font-medium">{{ modal.data.whitelistLabel }}</span>
          </label>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
            <textarea v-model="modal.data.remark" rows="3"
                      class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none"></textarea>
          </div>
        </div>
        <div v-if="modal.type === 'changePassword'" class="space-y-4 sm:p-4">
          <div v-if="modal.data.isAdmin">
            <label class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç </label>
            <input type="password" v-model="modal.data.newPassword"
                   class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none"
                   placeholder="è‡³å°‘6ä½">
          </div>
          <template v-else>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ—§å¯†ç </label>
              <input type="password" v-model="modal.data.oldPassword"
                     class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç </label>
              <input type="password" v-model="modal.data.newPassword"
                     class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none"
                     placeholder="è‡³å°‘6ä½">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤æ–°å¯†ç </label>
              <input type="password" v-model="modal.data.confirmPassword"
                     class="w-full rounded-lg border-gray-300 border p-2 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none">
            </div>
          </template>
        </div>
      </div>
      <div class="p-3 border-t bg-gray-50 flex justify-end gap-2 sm:gap-3">
        <button @click="closeModal"
                class="px-3 sm:px-4 py-2 rounded-lg border bg-white hover:bg-gray-100 text-gray-700 text-sm font-medium">
          å–æ¶ˆ
        </button>
        <button v-if="modal.onConfirm" @click="confirmModal"
                class="px-3 sm:px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium border border-emerald-700">
          ç¡®è®¤
        </button>
      </div>
    </div>
  </div>

  <div v-if="view === 'login'"
       class="flex-1 flex items-center justify-center bg-gradient-to-br from-emerald-500 to-teal-700 p-3 sm:p-4">
    <div class="bg-white rounded-2xl border border-gray-300 p-6 sm:p-8 w-full max-w-md space-y-5 sm:space-y-6">
      <div class="text-center space-y-2">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Unciv Server</h1>
        <p class="text-gray-500 text-sm">è¯·ç™»å½•ä»¥ç®¡ç†æœåŠ¡å™¨èµ„æº</p>
      </div>
      <form @submit.prevent="handleLogin" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
          <input v-model="loginForm.username" type="text" required
                 class="w-full px-4 py-2.5 sm:py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-base">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
          <input v-model="loginForm.password" type="password" required
                 class="w-full px-4 py-2.5 sm:py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none text-base">
        </div>
        <button type="submit" :disabled="loading"
                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          {{ loading ? 'ç™»å½•ä¸­...' : 'ç™» å½•' }}
        </button>
      </form>
    </div>
  </div>

  <div v-else-if="view !== 'loading'" class="flex-1 flex flex-col">
    <nav class="bg-white border-b sticky top-0 z-30">
      <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 h-14 sm:h-16 flex items-center justify-between gap-2">
        <div class="flex space-x-0.5 sm:space-x-1 bg-gray-100 p-0.5 sm:p-1 rounded-lg flex-shrink-0">
          <button v-for="tab in currentTabs" :key="tab.id"
                  @click="activeTab = tab.id"
                  :class="['px-2.5 sm:px-4 py-1.5 rounded-md text-xs sm:text-sm font-medium whitespace-nowrap',
                        activeTab === tab.id ? 'bg-white text-emerald-600' : 'text-gray-500 hover:text-gray-700']">
            {{ tab.name }}
          </button>
        </div>
        <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0">
          <div
            class="hidden sm:flex bg-gray-100 px-3 py-1 rounded-full text-sm font-medium text-gray-600 items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
            {{ userInfo.name }}
          </div>
          <button v-if="!isAdmin" @click="openChangeMyPassword"
                  class="text-xs sm:text-sm text-blue-600 hover:text-blue-700 font-medium hover:bg-blue-50 px-2 sm:px-3 py-1 rounded">
            æ”¹å¯†
          </button>
          <a href="/api/logout"
             class="text-xs sm:text-sm text-red-600 hover:text-red-700 font-medium hover:bg-red-50 px-2 sm:px-3 py-1 rounded">é€€å‡º</a>
        </div>
      </div>
    </nav>

    <main class="flex-1 max-w-7xl w-full mx-auto px-3 sm:px-4 lg:px-6 py-4 sm:py-6">

      <div v-if="contentLoading" class="flex flex-col items-center justify-center py-20 text-gray-400 animate-pulse">
        åŠ è½½æ•°æ®ä¸­...
      </div>

      <div v-else>
        <div v-if="isAdmin && activeTab === 'stats'"
             class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
          <stat-card label="ç©å®¶æ€»æ•°" :value="stats.playerCount" icon="ğŸ‘¥"></stat-card>
          <stat-card label="ç™½åå•ç©å®¶" :value="stats.whitelistPlayerCount" color="text-emerald-600"
                     icon="âœ…"></stat-card>
          <stat-card label="ä»Šæ—¥æ–°å¢" :value="stats.todayNewPlayers" sub="ç©å®¶" icon="ğŸ“ˆ"></stat-card>
          <stat-card label="7å¤©æ´»è·ƒ" :value="stats.activePlayers7Days" icon="ğŸ”¥"></stat-card>

          <stat-card label="æ¸¸æˆæ€»æ•°" :value="stats.gameCount" icon="ğŸ®"></stat-card>
          <stat-card label="ç™½åå•æ¸¸æˆ" :value="stats.whitelistGameCount" color="text-emerald-600"
                     icon="ğŸ›¡ï¸"></stat-card>
          <stat-card label="ä»Šæ—¥æ–°å¢" :value="stats.todayNewGames" sub="æ¸¸æˆ" icon="ğŸ†•"></stat-card>
          <stat-card label="å¹³å‡å›åˆ" :value="stats.avgGameTurns?.toFixed(1)" icon="â³"></stat-card>
        </div>

        <div v-if="isAdmin && activeTab === 'players'">
          <div
            class="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 mb-4 flex flex-col gap-3">
            <div class="flex flex-wrap gap-2 sm:gap-3 w-full">
              <input v-model="filters.playerSearch" placeholder="æœç´¢ ID æˆ–å¤‡æ³¨..."
                     class="flex-1 min-w-[140px] px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none bg-white text-sm">
              <select v-model="filters.playerWhitelist"
                      class="px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none bg-white text-sm">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="true">ç™½åå•</option>
                <option value="false">éç™½åå•</option>
              </select>
              <button @click="resetFilters" class="text-sm text-gray-500 hover:text-emerald-600 px-2">é‡ç½®</button>
            </div>
            <div v-if="selectedPlayers.length > 0"
                 class="flex flex-wrap items-center gap-2 sm:gap-3 bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-100">
              <span class="text-sm text-emerald-800 font-medium">é€‰ä¸­ {{ selectedPlayers.length }} é¡¹</span>
              <button @click="batchUpdatePlayers(true)"
                      class="px-3 py-1.5 rounded text-xs font-medium border border-emerald-700 bg-emerald-600 text-white">
                è®¾ä¸ºç™½åå•
              </button>
              <button @click="batchUpdatePlayers(false)"
                      class="px-3 py-1.5 rounded text-xs font-medium bg-white text-red-600 border border-red-200">
                å–æ¶ˆç™½åå•
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left min-w-[600px]">
                <thead class="bg-gray-50 text-gray-500 font-medium">
                <tr>
                  <th class="p-3 sm:p-4 w-10"><input type="checkbox" v-model="selectAllPlayers"
                                                     class="rounded text-emerald-600"></th>
                  <th class="p-3 sm:p-4">ç©å®¶ ID</th>
                  <th class="p-3 sm:p-4">çŠ¶æ€</th>
                  <th class="p-3 sm:p-4 hidden sm:table-cell">å¤‡æ³¨</th>
                  <th class="p-3 sm:p-4 hidden md:table-cell">æ³¨å†Œ/æ´»è·ƒ</th>
                  <th class="p-3 sm:p-4 text-right">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr v-for="p in filteredPlayers" :key="p.playerId" class="hover:bg-gray-50/50">
                  <td class="p-3 sm:p-4"><input type="checkbox" :value="p.playerId" v-model="selectedPlayers"
                                                class="rounded text-emerald-600"></td>
                  <td class="p-3 sm:p-4 font-mono text-gray-700 text-xs sm:text-sm break-all">{{ p.playerId }}</td>
                  <td class="p-3 sm:p-4">
                    <span
                      :class="['px-2 py-1 rounded-full text-xs font-medium text-nowrap', p.whitelist ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500']">
                        {{ p.whitelist ? 'ç™½åå•' : 'æ™®é€š' }}
                    </span>
                  </td>
                  <td class="p-3 sm:p-4 text-gray-500 truncate max-w-[150px] hidden sm:table-cell">{{ p.remark || '-'
                    }}
                  </td>
                  <td class="p-3 sm:p-4 text-xs text-gray-400 hidden md:table-cell">
                    <div>æ³¨: {{ formatDate(p.createdAt) }}</div>
                    <div>æ´»: {{ formatDate(p.updatedAt) }}</div>
                  </td>
                  <td class="p-3 sm:p-4 text-right space-x-1 sm:space-x-2 whitespace-nowrap">
                    <button @click="openEditPlayer(p)" class="text-emerald-600 hover:underline text-xs sm:text-sm">
                      ç¼–è¾‘
                    </button>
                    <button @click="viewPassword(p.playerId)"
                            class="text-gray-500 hover:text-gray-800 text-xs sm:text-sm">å¯†ç 
                    </button>
                    <button @click="openChangePlayerPassword(p.playerId)"
                            class="text-blue-600 hover:underline text-xs sm:text-sm">æ”¹å¯†
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <div v-if="filteredPlayers.length === 0" class="p-8 text-center text-gray-400">æš‚æ— æ•°æ®</div>
          </div>
        </div>

        <div v-if="isAdmin && activeTab === 'games'">
          <div
            class="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 mb-4 flex flex-col gap-3">
            <div class="flex flex-wrap gap-2 sm:gap-3 w-full">
              <input v-model="filters.gameSearch" placeholder="æœç´¢ ID æˆ–ç©å®¶..."
                     class="flex-1 min-w-[140px] px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none bg-white text-sm">
              <select v-model="filters.gameWhitelist"
                      class="px-3 sm:px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none bg-white text-sm">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="true">ç™½åå•</option>
                <option value="false">éç™½åå•</option>
              </select>
              <button @click="resetFilters" class="text-sm text-gray-500 hover:text-emerald-600 px-2">é‡ç½®</button>
            </div>
            <div v-if="selectedGames.length > 0"
                 class="flex flex-wrap items-center gap-2 sm:gap-3 bg-emerald-50 px-3 py-2 rounded-lg border border-emerald-100">
              <span class="text-sm text-emerald-800 font-medium">é€‰ä¸­ {{ selectedGames.length }} é¡¹</span>
              <button @click="batchUpdateGames(true)"
                      class="px-3 py-1.5 rounded text-xs font-medium border border-emerald-700 bg-emerald-600 text-white">
                è®¾ä¸ºç™½åå•
              </button>
              <button @click="batchUpdateGames(false)"
                      class="px-3 py-1.5 rounded text-xs font-medium bg-white text-red-600 border border-red-200">
                å–æ¶ˆç™½åå•
              </button>
              <button @click="batchDeleteGames"
                      class="px-3 py-1.5 rounded text-xs font-medium border border-red-700 bg-red-600 text-white">
                åˆ é™¤
              </button>
            </div>
          </div>

          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left min-w-[600px]">
                <thead class="bg-gray-50 text-gray-500 font-medium">
                <tr>
                  <th class="p-3 sm:p-4 w-10"><input type="checkbox" v-model="selectAllGames"
                                                     class="rounded text-emerald-600">
                  </th>
                  <th class="p-3 sm:p-4">Game ID / ç©å®¶</th>
                  <th class="p-3 sm:p-4">å›åˆ</th>
                  <th class="p-3 sm:p-4 hidden md:table-cell">æ—¶é—´</th>
                  <th class="p-3 sm:p-4">çŠ¶æ€</th>
                  <th class="p-3 sm:p-4 text-right">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr v-for="g in filteredGames" :key="g.gameId" class="hover:bg-gray-50/50">
                  <td class="p-3 sm:p-4"><input type="checkbox" :value="g.gameId" v-model="selectedGames"
                                                class="rounded text-emerald-600"></td>
                  <td class="p-3 sm:p-4">
                    <div class="font-mono text-emerald-700 font-medium text-xs sm:text-sm break-all">{{ g.gameId }}
                    </div>
                    <div class="text-xs text-gray-400 mt-1 flex flex-wrap gap-1">
                      <span v-for="p in g.players" class="bg-gray-100 px-1.5 rounded">{{ p }}</span>
                    </div>
                  </td>
                  <td class="p-3 sm:p-4">{{ g.turns || 0 }}</td>
                  <td class="p-3 sm:p-4 text-xs text-gray-400 hidden md:table-cell">
                    <div>åˆ›: {{ formatDate(g.createdAt) }}</div>
                    <div>æ›´: {{ formatDate(g.updatedAt) }}</div>
                  </td>
                  <td class="p-3 sm:p-4">
                    <span
                      :class="['px-2 py-1 rounded-full text-xs font-medium text-nowrap', g.whitelist ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500']">
                       {{ g.whitelist ? 'ç™½åå•' : 'æ™®é€š' }}
                    </span>
                  </td>
                  <td class="p-3 sm:p-4 text-right space-x-1 sm:space-x-2 whitespace-nowrap">
                    <button @click="openEditGame(g)" class="text-emerald-600 hover:underline text-xs sm:text-sm">ç¼–è¾‘
                    </button>
                    <button @click="viewHistory(g.gameId)"
                            class="text-blue-600 hover:underline text-xs sm:text-sm">å†å²
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div v-if="!isAdmin && activeTab === 'stats'" class="grid grid-cols-2 md:grid-cols-2 gap-3 sm:gap-6">
          <stat-card label="å‚ä¸æ¸¸æˆæ•°" :value="userStats.gameCount" icon="ğŸ®"></stat-card>
          <stat-card label="åˆ›å»ºæ¸¸æˆæ•°" :value="userStats.createdCount" icon="âœ¨" color="text-emerald-600"></stat-card>
        </div>

        <div v-if="!isAdmin && activeTab === 'games'">
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left min-w-[500px]">
                <thead class="bg-gray-50 text-gray-500 font-medium">
                <tr>
                  <th class="p-3 sm:p-4">Game ID</th>
                  <th class="p-3 sm:p-4">å›åˆ</th>
                  <th class="p-3 sm:p-4 hidden sm:table-cell">åˆ›å»ºæ—¶é—´</th>
                  <th class="p-3 sm:p-4 hidden md:table-cell">åˆ›å»ºè€…</th>
                  <th class="p-3 sm:p-4 text-right">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr v-for="g in userGames" :key="g.gameId" class="hover:bg-gray-50/50">
                  <td class="p-3 sm:p-4 font-mono font-medium text-emerald-700 text-xs sm:text-sm break-all">
                    {{ g.gameId}}
                  </td>
                  <td class="p-3 sm:p-4">{{ g.turns }}</td>
                  <td class="p-3 sm:p-4 text-gray-500 text-xs sm:text-sm hidden sm:table-cell">
                    {{ formatDate(g.createdAt) }}
                  </td>
                  <td class="p-3 sm:p-4 hidden md:table-cell">
                    <span v-if="g.createdPlayer === userInfo.id"
                          class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs">æˆ‘</span>
                    <span v-else class="text-gray-500 text-xs">{{ g.createdPlayer }}</span>
                  </td>
                  <td class="p-3 sm:p-4 text-right">
                    <div class="flex flex-wrap justify-end gap-1 sm:gap-2">
                      <button @click="viewHistory(g.gameId)"
                              class="px-2 sm:px-3 py-1 sm:py-1.5 rounded text-xs font-medium bg-white border border-gray-200 hover:bg-gray-50 text-gray-700">
                        å†å²
                      </button>
                      <button @click="downloadGame(g.gameId)"
                              class="px-2 sm:px-3 py-1 sm:py-1.5 rounded text-xs font-medium border border-emerald-700 bg-emerald-600 text-white hover:bg-emerald-700">
                        ä¸‹è½½
                      </button>
                      <button v-if="g.createdPlayer === userInfo.id" @click="deleteUserGame(g.gameId)"
                              class="px-2 sm:px-3 py-1 sm:py-1.5 rounded text-xs font-medium bg-red-50 text-red-600 border border-red-100 hover:bg-red-100">
                        åˆ é™¤
                      </button>
                    </div>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <div v-if="userGames.length === 0" class="p-8 text-center text-gray-400">æš‚æ— æ¸¸æˆ</div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div v-if="view === 'loading'" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
    <div class="text-emerald-600 font-medium animate-pulse flex flex-col items-center">
      æ­£åœ¨è¿æ¥æœåŠ¡å™¨...
    </div>
  </div>
</div>

<template id="stat-card-tpl">
  <div class="bg-white p-4 sm:p-6 rounded-xl border border-gray-200">
    <div class="flex items-center justify-between mb-1 sm:mb-2">
      <span class="text-gray-500 text-xs sm:text-sm font-medium">{{ label }}</span>
      <span class="text-xl sm:text-2xl">{{ icon }}</span>
    </div>
    <div class="flex items-baseline gap-1 sm:gap-2">
      <span :class="['text-2xl sm:text-3xl font-bold', color || 'text-gray-800']">{{ value || 0 }}</span>
      <span v-if="sub" class="text-xs text-gray-400">{{ sub }}</span>
    </div>
  </div>
</template>

<script>
  const API = {
    async request(url, options = {}) {
      options.credentials = 'include'
      options.headers = { 'Content-Type': 'application/json', ...options.headers }
      const res = await fetch(url, options)
      if (res.status === 401) throw new Error('Unauthorized')
      if (res.status === 204) return null
      if (!res.ok) {
        const err = await res.json()
        throw new Error(err.message || 'è¯·æ±‚å¤±è´¥')
      }
      return await res.json()
    },
    checkSession: () => API.request('/api/session'),
    login: (u, p) => API.request('/api/login', { method: 'POST', body: JSON.stringify({ username: u, password: p }) }),
    getStats: () => API.request('/api/stats'),
    getPlayers: () => API.request('/api/players'),
    getGames: () => API.request('/api/games'),
    getUserStats: () => API.request('/api/users/stats'),
    getUserGames: () => API.request('/api/users/games'),
    updatePlayer: (id, data) => API.request(`/api/players/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    getPlayerPwd: (id) => API.request(`/api/players/${id}/password`),
    updatePlayerPwd: (id, password) => API.request(`/api/players/${id}/password`, {
      method: 'PUT',
      body: JSON.stringify({ password }),
    }),
    updateUserPwd: (oldPassword, newPassword) => API.request('/api/users/password', {
      method: 'PUT',
      body: JSON.stringify({ oldPassword, newPassword }),
    }),
    updateGame: (id, data) => API.request(`/api/games/${id}`, { method: 'PUT', body: JSON.stringify(data) }),
    batchPlayers: (ids, wl) => API.request('/api/players/batch', {
      method: 'PATCH',
      body: JSON.stringify({ playerIds: ids, whitelist: wl }),
    }),
    batchGames: (ids, wl) => API.request('/api/games/batch', {
      method: 'PATCH',
      body: JSON.stringify({ gameIds: ids, whitelist: wl }),
    }),
    batchDelGames: (ids) => API.request('/api/games/batch', {
      method: 'DELETE',
      body: JSON.stringify({ gameIds: ids }),
    }),
    deleteGame: (id) => API.request(`/api/games/${id}`, { method: 'DELETE' }),
    getTurns: (id) => API.request(`/api/games/${id}/turns`),
  }
  const StatCard = {
    props: ['label', 'value', 'icon', 'color', 'sub'],
    template: '#stat-card-tpl',
  }
  const { createApp, ref, reactive, computed, onMounted, watch } = Vue
  createApp({
    components: { StatCard },
    setup() {
      // --- çŠ¶æ€ ---
      const view = ref('loading') // loading, login, app
      const isAdmin = ref(false)
      const userInfo = reactive({ name: '', id: '' })
      const loginForm = reactive({ username: '', password: '' })
      const loading = ref(false)
      const contentLoading = ref(false)
      const activeTab = ref('stats')
      // æ•°æ®
      const stats = ref({})
      const players = ref([])
      const games = ref([])
      const userStats = ref({})
      const userGames = ref([])
      // UI
      const toasts = ref([])
      const modal = reactive({ show: false, title: '', content: '', type: '', data: {}, onConfirm: null })
      // ç­›é€‰ & æ‰¹é‡
      const filters = reactive({ playerSearch: '', playerWhitelist: '', gameSearch: '', gameWhitelist: '' })
      const selectedPlayers = ref([])
      const selectedGames = ref([])
      // --- è®¡ç®—å±æ€§ ---
      const currentTabs = computed(() => {
        if (isAdmin.value) {
          return [
            { id: 'stats', name: 'æ•°æ®æ¦‚è§ˆ' }, { id: 'players', name: 'ç©å®¶ç®¡ç†' }, { id: 'games', name: 'æ¸¸æˆç®¡ç†' },
          ]
        }
        return [{ id: 'stats', name: 'æˆ‘çš„ç»Ÿè®¡' }, { id: 'games', name: 'æˆ‘çš„æ¸¸æˆ' }]
      })
      const filteredPlayers = computed(() => {
        return players.value.filter(p => {
          const matchS = !filters.playerSearch || p.playerId.includes(filters.playerSearch) || (p.remark || '').includes(filters.playerSearch)
          const matchW = filters.playerWhitelist === '' || String(p.whitelist) === filters.playerWhitelist
          return matchS && matchW
        })
      })
      const filteredGames = computed(() => {
        return games.value.filter(g => {
          const matchS = !filters.gameSearch || g.gameId.includes(filters.gameSearch) || g.players.some(x => x.includes(filters.gameSearch))
          const matchW = filters.gameWhitelist === '' || String(g.whitelist) === filters.gameWhitelist
          return matchS && matchW
        })
      })
      const selectAllPlayers = computed({
        get: () => filteredPlayers.value.length > 0 && selectedPlayers.value.length === filteredPlayers.value.length,
        set: (val) => selectedPlayers.value = val ? filteredPlayers.value.map(p => p.playerId) : [],
      })
      const selectAllGames = computed({
        get: () => filteredGames.value.length > 0 && selectedGames.value.length === filteredGames.value.length,
        set: (val) => selectedGames.value = val ? filteredGames.value.map(g => g.gameId) : [],
      })
      // --- æ–¹æ³• ---
      const showToast = (msg, type = 'success') => {
        const id = Date.now()
        toasts.value.push({ id, message: msg, type })
        setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000)
      }
      const closeModal = () => {
        modal.show = false
        modal.onConfirm = null
      }
      const confirmModal = async () => {
        if (modal.onConfirm) {
          try {
            await modal.onConfirm()
            closeModal()
          } catch (e) {
            showToast(e.message || e, 'error')
          }
        }
      }
      // åˆå§‹åŒ–
      onMounted(async () => {
        try {
          const session = await API.checkSession()
          if (session.isLoggedIn) {
            isAdmin.value = session.isAdmin
            userInfo.name = session.isAdmin ? 'ç®¡ç†å‘˜' : 'ç©å®¶' // å¯ä»¥åœ¨è¿™é‡Œè·å–çœŸå®ID
            view.value = 'app'
            loadTabData()
          } else {
            view.value = 'login'
          }
        } catch (e) {
          view.value = 'login'
        }
      })
      // ç›‘å¬ Tab åˆ‡æ¢
      watch(activeTab, () => loadTabData())
      const loadTabData = async () => {
        contentLoading.value = true
        try {
          if (isAdmin.value) {
            if (activeTab.value === 'stats') stats.value = await API.getStats()
            if (activeTab.value === 'players') players.value = await API.getPlayers()
            if (activeTab.value === 'games') games.value = await API.getGames()
          } else {
            if (activeTab.value === 'stats') userStats.value = await API.getUserStats()
            if (activeTab.value === 'games') {
              const data = await API.getUserGames()
              userGames.value = data.games
              userInfo.id = data.playerId
              userInfo.name = data.playerId
            }
          }
        } catch (e) {
          if (e.message === 'Unauthorized') location.reload()
          showToast(e.message, 'error')
        } finally {
          contentLoading.value = false
        }
      }
      const handleLogin = async () => {
        loading.value = true
        try {
          const res = await API.login(loginForm.username, loginForm.password)
          isAdmin.value = res.isAdmin
          userInfo.name = res.isAdmin ? 'ç®¡ç†å‘˜' : loginForm.username
          view.value = 'app'
          activeTab.value = 'stats'
          loadTabData()
        } catch (e) {
          showToast(e.message || 'ç™»å½•å¤±è´¥', 'error')
        } finally {
          loading.value = false
        }
      }
      // --- ä¸šåŠ¡æ“ä½œ ---
      const formatDate = (str) => new Date(str).toLocaleString('zh-CN', { hour12: false })
      const resetFilters = () => { Object.keys(filters).forEach(k => filters[k] = '') }
      // é€šç”¨ç¼–è¾‘æ“ä½œ
      const openEdit = (type, id, data, updateFn) => {
        modal.title = `ç¼–è¾‘${type}: ${id}`
        modal.type = 'edit'
        modal.data = { whitelist: data.whitelist, remark: data.remark || '', whitelistLabel: `ç™½åå•${type}` }
        modal.onConfirm = async () => {
          await updateFn(id, { whitelist: modal.data.whitelist, remark: modal.data.remark })
          showToast('æ›´æ–°æˆåŠŸ')
          loadTabData()
        }
        modal.show = true
      }
      const openEditPlayer = (p) => openEdit('ç©å®¶', p.playerId, p, API.updatePlayer)
      const viewPassword = async (id) => {
        try {
          const res = await API.getPlayerPwd(id)
          modal.title = 'æŸ¥çœ‹å¯†ç '
          modal.type = 'html'
          modal.content = `<div class="bg-gray-100 p-4 rounded text-center font-mono select-all text-xl tracking-wider">${res.password}</div>`
          modal.show = true
        } catch (e) { throw new Error(e.message) }
      }
      const openChangePlayerPassword = (playerId) => {
        modal.title = `ä¿®æ”¹å¯†ç : ${playerId}`
        modal.type = 'changePassword'
        modal.data = { playerId, isAdmin: true, newPassword: '' }
        modal.onConfirm = async () => {
          if (!modal.data.newPassword || modal.data.newPassword.length < 6) {
            throw new Error('å¯†ç è‡³å°‘6ä½')
          }
          await API.updatePlayerPwd(playerId, modal.data.newPassword)
        }
        modal.show = true
      }
      const openChangeMyPassword = () => {
        modal.title = 'ä¿®æ”¹æˆ‘çš„å¯†ç '
        modal.type = 'changePassword'
        modal.data = { isAdmin: false, oldPassword: '', newPassword: '', confirmPassword: '' }
        modal.onConfirm = async () => {
          if (!modal.data.oldPassword) {
            throw new Error('è¯·è¾“å…¥æ—§å¯†ç ')
          }
          if (!modal.data.newPassword || modal.data.newPassword.length < 6) {
            throw new Error('æ–°å¯†ç è‡³å°‘6ä½')
          }
          if (modal.data.newPassword !== modal.data.confirmPassword) {
            throw new Error('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´')
          }
          await API.updateUserPwd(modal.data.oldPassword, modal.data.newPassword)
          showToast('å¯†ç ä¿®æ”¹æˆåŠŸ')
        }
        modal.show = true
      }
      const batchUpdatePlayers = async (wl) => {
        if (!selectedPlayers.value.length) return
        if (!confirm(`ç¡®å®šæ›´æ–° ${selectedPlayers.value.length} ä¸ªç©å®¶å—ï¼Ÿ`)) return
        try {
          await API.batchPlayers(selectedPlayers.value, wl)
          showToast('æ‰¹é‡æ“ä½œæˆåŠŸ')
          selectedPlayers.value = []
          loadTabData()
        } catch (e) { showToast(e.message, 'error') }
      }
      const openEditGame = (g) => openEdit('æ¸¸æˆ', g.gameId, g, API.updateGame)
      const batchUpdateGames = async (wl) => {
        if (!selectedGames.value.length) return
        try {
          await API.batchGames(selectedGames.value, wl)
          showToast('æ“ä½œæˆåŠŸ')
          selectedGames.value = []
          loadTabData()
        } catch (e) { showToast(e.message, 'error') }
      }
      const batchDeleteGames = async () => {
        if (!selectedGames.value.length) return
        if (!confirm('æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šåˆ é™¤ï¼Ÿ')) return
        try {
          await API.batchDelGames(selectedGames.value)
          showToast('åˆ é™¤æˆåŠŸ')
          selectedGames.value = []
          loadTabData()
        } catch (e) { showToast(e.message, 'error') }
      }
      // å†å²ä¸ä¸‹è½½
      const viewHistory = async (gid) => {
        try {
          const turns = await API.getTurns(gid)
          let html = `<div class="overflow-x-auto"><table class="w-full text-sm text-left">
                    <thead class="bg-gray-50"><tr><th class="p-2">å›åˆ</th><th class="p-2">ç©å®¶</th><th class="p-2">æ—¶é—´</th><th class="p-2">æ“ä½œ</th></tr></thead><tbody>`
          turns.forEach(t => {
            html += `<tr class="border-b"><td class="p-2">${t.turns}</td><td class="p-2">${t.createdPlayer || '-'}</td>
                    <td class="p-2">${formatDate(t.createdAt)}</td>
                    <td class="p-2"><a href="/api/games/${gid}/turns/${t.id}/download" class="text-emerald-600 hover:underline">ä¸‹è½½</a></td></tr>`
          })
          html += '</tbody></table></div>'
          modal.title = `æ¸¸æˆå†å²: ${gid}`
          modal.type = 'html'
          modal.content = turns.length ? html : '<p class="text-center text-gray-500 py-4">æš‚æ— è®°å½•</p>'
          modal.show = true
        } catch (e) { showToast('æ— æ³•è·å–å†å²', 'error') }
      }
      const downloadGame = (gid) => window.location.href = `/api/games/${gid}/download`
      const deleteUserGame = async (gid) => {
        if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¸¸æˆï¼Ÿ')) return
        try {
          await API.deleteGame(gid)
          showToast('åˆ é™¤æˆåŠŸ')
          loadTabData()
        } catch (e) { showToast(e.message, 'error') }
      }
      return {
        view, isAdmin, userInfo, loginForm, loading, contentLoading, activeTab, currentTabs,
        stats, userStats, userGames,
        filters, filteredPlayers, filteredGames, selectedPlayers, selectedGames, selectAllPlayers, selectAllGames,
        toasts, modal,
        handleLogin, formatDate, resetFilters,
        openEditPlayer, viewPassword, openChangePlayerPassword, openChangeMyPassword, batchUpdatePlayers,
        openEditGame, batchUpdateGames, batchDeleteGames,
        viewHistory, downloadGame, deleteUserGame,
        closeModal, confirmModal,
      }
    },
  }).mount('#app')
</script>
</body>
</html>
